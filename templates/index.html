<!DOCTYPE html>
<html>
<head>
    <title>Remote Command Tool</title>
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>
    <h1 class="brand">KACPER HUB</h1>
    <h2>Remote Commands</h2>
    {% set service_presets = [
        "haproxy",
        "grafana-server",
        "zabbix-agent2",
        "docker",
        "postgres@15",
        "postgresql@15-main",
        "apache2",
        "nginx",
        "kibana",
        "elasticsearch",
        "influxdb",
        "pgbouncer",
        "jenkins"
    ] %}
    {% set fping_presets = [
        ("10.17.10.1", "10.17.10.254"),
        ("10.17.110.1", "10.17.110.254"),
        ("172.17.3.1", "172.17.3.254"),
        ("172.17.4.1", "172.17.4.254"),
        ("172.16.3.1", "172.16.3.254"),
        ("172.16.4.1", "172.16.4.254")
    ] %}
    {% set extra_ips = [ip2, ip3, ip4, ip5, ip6, ip7, ip8, ip9, ip10] %}

    <form method="post" id="cmd-form">
        <div class="row">
            <label>IP</label>
            <input type="text" name="ip" placeholder="IP of machine where command will run" value="{{ ip }}" required id="ip1-input" />
            <select id="machine-count-select" class="inline-select" name="machine_count">
                {% for n in range(1, 11) %}
                <option value="{{ n }}" {% if machine_count == n %}selected{% endif %}>{{ n }} machine{% if n > 1 %}s{% endif %}</option>
                {% endfor %}
            </select>
        </div>
        {% for addr in extra_ips %}
        {% set ip_idx = loop.index + 1 %}
        <div class="row machine-ip-row" id="ip{{ ip_idx }}-row" style="display:none;">
            <label>IP #{{ ip_idx }}</label>
            <input type="text" name="ip{{ ip_idx }}" id="ip{{ ip_idx }}-input" placeholder="Machine IP #{{ ip_idx }}" value="{{ addr }}" />
        </div>
        {% endfor %}
        <div class="row">
            <label>User</label>
            <input type="text" name="username" id="username-input" placeholder="admin" value="{{ username }}" required />
        </div>
        <div class="row">
            <label>Password</label>
            <input type="password" name="password" id="password-input" placeholder="password" value="{{ password }}" required />
        </div>
        <div class="row" id="ping-row" style="display:none;">
            <label>Ping to</label>
            <input type="text" name="ping_target" placeholder="8.8.8.8" value="{{ ping_target }}" />
        </div>
        <div class="row" id="fping-row" style="display:none;">
            <label>fping range</label>
            <input type="text" name="fping_start_ip" id="fping-start-input" placeholder="10.17.10.1" value="{{ fping_start_ip }}" />
            <input type="text" name="fping_end_ip" id="fping-end-input" class="inline-select" placeholder="10.17.10.254" value="{{ fping_end_ip }}" />
            <select id="fping-range-preset" class="inline-select">
                <option value="">Choose range preset...</option>
                {% for start_ip, end_ip in fping_presets %}
                <option value="{{ start_ip }}|{{ end_ip }}">{{ start_ip }} - {{ end_ip }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="row" id="route-get-row" style="display:none;">
            <label>Route get</label>
            <input type="text" name="route_get_target" placeholder="1.1.1.1" value="{{ route_get_target }}" />
        </div>
        <div class="row" id="curl-row" style="display:none;">
            <label>URL</label>
            <input type="text" name="curl_target" id="curl-target-input" placeholder="https://example.com" value="{{ curl_target }}" />
        </div>
        <div class="row" id="curl-method-row" style="display:none;">
            <label>Method</label>
            <input type="text" name="curl_method" id="curl-method-input" placeholder="GET" value="{{ curl_method }}" />
        </div>
        <div class="row" id="docker-logs-row" style="display:none;">
            <label>Container</label>
            <input type="text" name="docker_container" id="docker-container-input" placeholder="container name" value="{{ docker_container }}" />
        </div>
        <div class="row" id="systemctl-row" style="display:none;">
            <label>Service</label>
            <input type="text" name="service_name" id="service-name-input" placeholder="service name" value="{{ service_name }}" />
            <select id="service-preset" class="inline-select">
                <option value="">Choose preset service...</option>
                {% for svc in service_presets %}
                <option value="{{ svc }}">{{ svc }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="row" id="custom-row" style="display:none;">
            <label>Command</label>
            <input type="text" name="custom_command" id="custom-command-input" placeholder="custom shell command" value="{{ custom_command }}" />
        </div>
        <input type="hidden" name="action" id="action" value="{{ last_action }}">
        <div class="row actions">
            <button type="button" id="custom-btn">Custom</button>
            <button type="button" id="ping-btn">Ping</button>
            <button type="button" id="fping-btn">fping scan</button>
            <button type="button" id="route-btn">IP route</button>
            <button type="button" id="route-get-btn">IP route get</button>
            <div class="split" id="curl-split">
                <button type="button" class="split-main" id="curl-btn">Curl</button>
                <button type="button" class="split-toggle" id="curl-toggle-btn">▾</button>
                <div class="split-menu" id="curl-menu" hidden>
                    <button type="button" class="menu-item" data-action="curl_i"><span>curl -I</span><span class="menu-help" title="Fetch headers only (HTTP status and response headers).">?</span></button>
                    <button type="button" class="menu-item" data-action="curl_ss"><span>curl -sS</span><span class="menu-help" title="Silent mode but still show errors.">?</span></button>
                    <button type="button" class="menu-item" data-action="curl_plain"><span>curl</span><span class="menu-help" title="Fetch full response body with default curl output.">?</span></button>
                    <button type="button" class="menu-item" data-action="curl_x"><span>curl -X</span><span class="menu-help" title="Force HTTP method, for example GET/POST/PUT/DELETE.">?</span></button>
                </div>
            </div>
            <div class="split" id="docker-split">
                <button type="button" class="split-main" id="docker-btn">Docker ps</button>
                <button type="button" class="split-toggle" id="docker-toggle-btn">▾</button>
                <div class="split-menu" id="docker-menu" hidden>
                    <button type="button" class="menu-item" data-action="docker_ps"><span>docker ps</span><span class="menu-help" title="List running containers.">?</span></button>
                    <button type="button" class="menu-item" data-action="docker_stats"><span>docker stats --no-stream</span><span class="menu-help" title="Show one-time CPU and memory usage snapshot for containers.">?</span></button>
                    <button type="button" class="menu-item" data-action="docker_logs"><span>docker logs --tail 200</span><span class="menu-help" title="Show last 200 log lines from the selected container.">?</span></button>
                </div>
            </div>
            <button type="button" id="df-btn">df -h</button>
            <div class="split" id="ss-split">
                <button type="button" class="split-main" id="ss-btn">ss -tulpn</button>
                <button type="button" class="split-toggle" id="ss-toggle-btn">▾</button>
                <div class="split-menu" id="ss-menu" hidden>
                    <button type="button" class="menu-item" data-action="ss_tulpn"><span>ss -tulpn</span><span class="menu-help" title="Listening TCP/UDP sockets with process names and numeric addresses.">?</span></button>
                    <button type="button" class="menu-item" data-action="ss_ant"><span>ss -ant</span><span class="menu-help" title="All TCP sockets in numeric format, including established connections.">?</span></button>
                </div>
            </div>
            <button type="button" id="uptime-btn">uptime</button>
            <button type="button" id="du-var-btn">du /var/log sorted</button>
            <div class="split" id="systemctl-split">
                <button type="button" class="split-main" id="systemctl-btn">systemctl status</button>
                <button type="button" class="split-toggle" id="systemctl-toggle-btn">▾</button>
                <div class="split-menu" id="systemctl-menu" hidden>
                    <button type="button" class="menu-item" data-action="systemctl_status"><span>systemctl status</span><span class="menu-help" title="Show current service state and recent logs.">?</span></button>
                    <button type="button" class="menu-item" data-action="systemctl_restart"><span>systemctl restart</span><span class="menu-help" title="Restart service immediately.">?</span></button>
                    <button type="button" class="menu-item" data-action="systemctl_stop"><span>systemctl stop</span><span class="menu-help" title="Stop service until started again.">?</span></button>
                </div>
            </div>
        </div>
    </form>

    {% if result_blocks %}
    <div class="output-list">
        {% for block in result_blocks %}
        <section class="output-card">
            <div class="output-title">{{ block.title }}</div>
            <pre class="output-body">{{ block.body }}</pre>
        </section>
        {% endfor %}
    </div>
    {% else %}
    <pre class="output">{{ result }}</pre>
    {% endif %}
    <script src="/static/app.js" defer></script>
</body>
</html>
